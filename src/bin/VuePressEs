#!/usr/bin/env node

const program = require('commander') // æ ¸å¿ƒå‘½ä»¤è¡Œå·¥å…·
const Printer = require('@darkobits/lolcatjs') // å­—ä½“æ¸å˜ï¼ˆç¾è§‚ç”¨ï¼Œæ²¡å•¥å…¶ä»–ç”¨å¤„ï¼Œä¸»è¦æ˜¯èŠ±é‡Œèƒ¡å“¨ï¼‰
const inquirer = require('inquirer') // è·Ÿç”¨æˆ·è¿›è¡Œäº¤äº’
const ora = require('ora') // loadingæ¨¡å—
const shelljs = require('shelljs'); // å‰ç«¯å†™shell

// åˆå§‹åŒ–å‡½æ•°
function init () {
    programConfigFn() // æ ¸å¿ƒå‘½ä»¤è¡Œé…ç½®å‡½æ•°
}

// æ ¸å¿ƒå‘½ä»¤è¡Œé…ç½®å‡½æ•°
function programConfigFn () {
    
    // -v ç‰ˆæœ¬
    program.version('v1.0.0', "-v, --version")
    // -h å¸®åŠ©
    program.on('--help', () => { console.log(Printer.default.fromString(titleFu())) });

    program
        .usage("[cmd] <options>")
        .arguments('<cmd> [env]')
        .action( (cmd, otherParms) => {
            let header = binHeaderFn(cmd)
            typeof header === 'undefined' ? process.exit(1) : header()
        })

    program.parse(process.argv)
}

// å‘½ä»¤é›†åˆå‡½æ•°
const binHeaderFn = cmd => {
    
    let binHeader = {

        // åˆå§‹åŒ–é¡¹ç›®é›†åˆ
        init () {
            inquirer.prompt([
                {
                    type: 'text',
                    message: 'æ­¤æ“ä½œä¼šåœ¨å½“å‰è·¯å¾„ä¸‹åˆ›å»ºåˆå§‹åŒ–æ–‡ä»¶å¤¹ï¼Œè¯·æ‚¨è‡ªå®šä¹‰æ­¤æ–‡ä»¶å¤¹åç§°ï¼ˆè‹±æ–‡ï¼‰',
                    name: 'dirname'
                }
            ]).then( answers => {
                
                let { dirname } = answers
                
                const spinner = ora('vpeæ­£åœ¨ä¸ºæ‚¨åˆå§‹åŒ–é¡¹ç›®')
                spinner.start()

                let initCreateAppJs = initCreateAppJsFn(dirname) // ç”Ÿæˆåˆå§‹åŒ– init app.js
                shelljs.echo(initCreateAppJs).to('app.js')

                setTimeout( () => {
                    
                    shelljs.cd(shelljs.pwd().stdout) // è¿›å…¥å½“å‰ç›®å½•
                    shelljs.mkdir(dirname)

                    shelljs.exec('node app.js')
                    shelljs.exec('npx vuepress dev docs')
                    
                    spinner.stop()
                    console.log('åˆå§‹åŒ–å®Œæˆ')
                }, 1000)
            })
        },

        server () {
            console.log('å¯åŠ¨é¡¹ç›®é¢„è§ˆ')
        },

        build () {
            console.log('æ‰“åŒ…ç”Ÿæˆ html æ–‡ä»¶')
        }
    
    }

    return binHeader[cmd]

}

// titleæ–‡å­—
function titleFu () {
return `
__   __  _ __     ___ 
\\ \\ / / | '_ \\   / _ \\
 \\ V /  | |_) | |  __/
  \\_/   | .__/   \\___|
        |_|                                                                   

è¯´æ˜ï¼š.md ---> .htmlï¼ˆç®€åŒ–VuePressé…ç½®ï¼‰

- vpe init ç”Ÿæˆåˆå§‹åŒ–é¡¹ç›®ï¼ˆå¹¶å¯åŠ¨é¡¹ç›®é¢„è§ˆï¼‰
- vpe server å¯åŠ¨é¡¹ç›®é¢„è§ˆ
- vpe build æ‰“åŒ…ç”Ÿæˆ html æ–‡ä»¶

`
}

// ç”Ÿæˆé¦–é¡µæ–‡å­—å‡½æ•°
function homeTileFn (dirname) {
return `---
home: true
heroImage: https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/github%E5%9B%BE%E7%89%87/notes/3.png
actionText: ğŸ”¥ è¿™é‡Œæ˜¯ä¸ªæŒ‰é’® â†’
actionLink: /${dirname}/
features:
- title: è§£é‡Šä¸€
  details: è§£é‡Šä¸€å†…å®¹
- title: è§£é‡ŠäºŒ
  details: è§£é‡ŠäºŒå†…å®¹
- title: è§£é‡Šä¸‰
  details: è§£é‡Šä¸‰å†…å®¹
footer: MIT Licensed | Â© Copyright 2019 æœ±æ˜†é¹ - All Rights Reservedï¼ˆç¤ºä¾‹ï¼‰
---`
}

// init æ—¶å€™ç”Ÿæˆçš„ app.js
function initCreateAppJsFn (dirname) {

let homeTile = homeTileFn(dirname)

return `let fs = require("fs");
let path = require('path')
let stat = fs.stat;

// åŒæ­¥è¯»å–
let homeTile = \`${homeTile}\`

function init() {
        
    // 1.åˆ¤æ–­å¦‚æœæœ‰docsç›®å½•ï¼Œå°±åˆ é™¤æ‰ docsç›®å½•
    if (fs.existsSync(path.join(__dirname,'docs'))) {
        delDirT(path.join(__dirname,'docs'))
    }

    // 2.åˆ›å»ºç›®å½•
    fs.mkdirSync(path.join(__dirname, 'docs'))
    fs.mkdirSync(path.join(__dirname, './docs/.vuepress'))

    // 2.5 å°† record.md å†…å®¹å¤åˆ¶åˆ° æ–‡ä»¶ä¸‹ï¼Œé˜²æ­¢æŠ¥404ï¼ˆå¼‚æ­¥ï¼‰
    fs.readFile('record.md', function (err, data) {
        fs.writeFile('./docs/${dirname}/README.md', data,  function(err) {
          if (err) {
              return console.error(err);
          }
        });
    })

    // 3.æ–‡ä»¶å¤¹å¤åˆ¶
    existsT('./${dirname}','./docs/${dirname}',copyT)

    // 4.ç”Ÿæˆ README.md è¦ä¸ä¼šé¦–é¡µä¼šæŠ¥404
    fs.writeFileSync('./docs/README.md', homeTile)
    
    // 5.éå† ç”Ÿæˆè·¯å¾„å¯¼èˆªï¼ˆç”Ÿæˆè§„åˆ™å†™å…¥ config.jsä¸­ï¼‰
    let strOne = ''
    let one = fs.readdirSync('./${dirname}')
    one.forEach(item => {
        if (!/.md/.${dirname}(item) && item !== '.DS_Store') {
    
          let files2 = []
          let files2Str = ''
          fs.readdirSync(path.join('./${dirname}', item)).forEach( item1 => {
            // Macç³»ç»Ÿä¸‹çš„é—®é¢˜
            if (item1 !== '.DS_Store') {
              files2.push(\`\${path.join(path.join('./${dirname}', item), item1)}\`)
            }
          })
    
          files2.forEach( item2 => {
            files2Str += \`
            '\${item2}',\`
          })
    
          strOne += \`
            {
              title: '\${item}',
              children: [\${files2Str}]
            },
          \`
        }
    })

    // å†™å…¥
    let configStr = \`
    module.exports = {
      title: 'Notes',
      description: 'çŸ¥è¯†é€ŸæŸ¥ï¼ˆäº†ä¸èµ·çš„ä¸ªäººå·¥å…·åº“ï¼‰',
      head: [
        ['link', { rel: 'icon', href: '/favicon.ico' }]
      ],
      themeConfig: {
        repo: 'https://github.com/zhukunpenglinyutong/notes',
        //å¯¼èˆª
        nav: [
          { text: '${dirname}', link: '/${dirname}/' }
        ],
        // ä¾§è¾¹æ 
        sidebar: {
          '/${dirname}': [
            \${strOne}
          ]
        }
      },
      serviceWorker: true,
    }
    \`

    fs.writeFileSync('./docs/.vuepress/config.js', configStr)
}

// å¤åˆ¶æ–‡ä»¶å¤¹
function existsT (src, dst, callback) {
  //æµ‹è¯•æŸä¸ªè·¯å¾„ä¸‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  fs.exists(dst,function(existsT){
      if(existsT){//ä¸å­˜åœ¨
          callback(src,dst);
      }else{//å­˜åœ¨
          fs.mkdir(dst,function(){//åˆ›å»ºç›®å½•
              callback(src,dst)
          })
      }
  })
}

// å¤åˆ¶æ–‡ä»¶å¤¹çš„è¾…åŠ©å‡½æ•°
function copyT (src, dst) {
  //è¯»å–ç›®å½•
  fs.readdir(src,function(err,paths){
      // console.log(paths)
      if(err){
          throw err;
      }
      paths.forEach(function(path){
          var _src=src+'/'+path;
          var _dst=dst+'/'+path;
          var readable;
          var writable;
          stat(_src,function(err,st){
              if(err){
                  throw err;
              }
              
              if(st.isFile()){
                  readable=fs.createReadStream(_src);//åˆ›å»ºè¯»å–æµ
                  writable=fs.createWriteStream(_dst);//åˆ›å»ºå†™å…¥æµ
                  readable.pipe(writable);
              }else if(st.isDirectory()){
                  exists(_src,_dst,copyT);
              }
          });
      });
  });
}



// åˆ é™¤æ–‡ä»¶å¤¹
function delDirT (path){
    let files = [];
    if(fs.existsSync(path)){
        files = fs.readdirSync(path);
        files.forEach((file, index) => {
            let curPath = path + "/" + file;
            if(fs.statSync(curPath).isDirectory()){
                delDirT(curPath); //é€’å½’åˆ é™¤æ–‡ä»¶å¤¹
            } else {
                fs.unlinkSync(curPath); //åˆ é™¤æ–‡ä»¶
            }
        });
        fs.rmdirSync(path);
    }
}

init() // å¯åŠ¨`

}

init()