#!/usr/bin/env node

const program = require('commander') // æ ¸å¿ƒå‘½ä»¤è¡Œå·¥å…·
const Printer = require('@darkobits/lolcatjs') // å­—ä½“æ¸å˜ï¼ˆç¾è§‚ç”¨ï¼Œæ²¡å•¥å…¶ä»–ç”¨å¤„ï¼Œä¸»è¦æ˜¯èŠ±é‡Œèƒ¡å“¨ï¼‰
const inquirer = require('inquirer') // è·Ÿç”¨æˆ·è¿›è¡Œäº¤äº’
const ora = require('ora') // loadingæ¨¡å—
const shelljs = require('shelljs'); // å‰ç«¯å†™shell
const fs = require('fs');
const path = require('path');
let stat = fs.stat;

// åˆå§‹åŒ–å‡½æ•°
function init () {
    programConfigFn() // æ ¸å¿ƒå‘½ä»¤è¡Œé…ç½®å‡½æ•°
}

// æ ¸å¿ƒå‘½ä»¤è¡Œé…ç½®å‡½æ•°
function programConfigFn () {
    
    // -v ç‰ˆæœ¬
    program.version('v1.0.0', "-v, --version")
    // -h å¸®åŠ©
    program.on('--help', () => { console.log(Printer.default.fromString(titleFu())) });

    program
        .usage("[cmd] <options>")
        .arguments('<cmd> [env]')
        .action( (cmd, otherParms) => {
            let header = binHeaderFn(cmd)
            typeof header === 'undefined' ? process.exit(1) : header()
        })

    program.parse(process.argv)
}

// å‘½ä»¤é›†åˆå‡½æ•°
const binHeaderFn = cmd => {
    
    let binHeader = {

        // åˆå§‹åŒ–é¡¹ç›®é›†åˆ
        init () {
            console.log('ç”Ÿæˆä¸€ä¸ªåˆå§‹åŒ–é¡¹ç›®ï¼ˆåŠŸèƒ½æš‚æœªå¼€æ”¾ï¼‰')
            // inquirer.prompt([
            //     {
            //         type: 'text',
            //         message: 'æ­¤æ“ä½œä¼šåœ¨å½“å‰è·¯å¾„ä¸‹åˆ›å»ºåˆå§‹åŒ–æ–‡ä»¶å¤¹ï¼Œè¯·æ‚¨è‡ªå®šä¹‰æ­¤æ–‡ä»¶å¤¹åç§°ï¼ˆè‹±æ–‡ï¼‰',
            //         name: 'dirname'
            //     }
            // ]).then( answers => {
                
            //     let { dirname } = answers
                
            //     const spinner = ora('vpeæ­£åœ¨ä¸ºæ‚¨åˆå§‹åŒ–é¡¹ç›®')
            //     spinner.start()

            //     let initCreateAppJs = initCreateAppJsFn(dirname) // ç”Ÿæˆåˆå§‹åŒ– init app.js
            //     shelljs.echo(initCreateAppJs).to('app.js')

            //     setTimeout( () => {
                    
            //         shelljs.cd(shelljs.pwd().stdout) // è¿›å…¥å½“å‰ç›®å½•
            //         shelljs.mkdir(dirname)

            //         shelljs.exec('node app.js')
            //         shelljs.exec('npx vuepress dev docs')
                    
            //         spinner.stop()
            //         console.log('åˆå§‹åŒ–å®Œæˆ')
            //     }, 1000)
            // })
        },

        serve () {
            
            let dirObjTree = readDirToObjTree() // éå†æ‰€æœ‰çš„æ–‡ä»¶å¤¹ ---> ç”Ÿæˆæ–‡ä»¶å¯¹è±¡æ ‘            
            createVuePressInit(dirObjTree) // æ ¹æ®æ–‡ä»¶å¯¹è±¡æ ‘ï¼Œç”ŸæˆVuePressè§„åˆ™


            const spinner = ora('vpeæ­£åœ¨å¯åŠ¨é¢„è§ˆåŠŸèƒ½...')
            spinner.start()

            // æš‚åœ 1sï¼Œä¸»è¦æ˜¯æœ‰ä¸ªåŠ è½½çŠ¶æ€ï¼Œè£…Bç”¨ ğŸ˜¸
            setTimeout(() => {
                let npmList = shelljs.exec('npm list --dept 0') // é¦–å…ˆåˆ¤æ–­æ˜¯å¦å®‰è£…äº†VuePress
                let isNpmVuePress = /vuepress@/.test(npmList)
    
                if (isNpmVuePress) {
                    shelljs.exec('npx vuepress dev build') // æ‰§è¡Œshè„šæœ¬
                    spinner.stop()
                } else {
                    console.log('â£ï¸  æ‚¨è¿˜æœªå®‰è£… vuepressï¼ˆnpm install vuepress --saveï¼‰ ')
                    spinner.stop()
                }
            }, 1000)
        },

        build () {

            let dirObjTree = readDirToObjTree() // éå†æ‰€æœ‰çš„æ–‡ä»¶å¤¹ ---> ç”Ÿæˆæ–‡ä»¶å¯¹è±¡æ ‘            
            createVuePressInit(dirObjTree) // æ ¹æ®æ–‡ä»¶å¯¹è±¡æ ‘ï¼Œç”ŸæˆVuePressè§„åˆ™


            const spinner = ora('vpeæ­£åœ¨ç¼–è¯‘ä¸­ï¼ˆç¼–è¯‘åçš„æ–‡ä»¶åœ¨ build/.vuepress/dist ä¸­ï¼‰')
            spinner.start()

            // æš‚åœ 1sï¼Œä¸»è¦æ˜¯æœ‰ä¸ªåŠ è½½çŠ¶æ€ï¼Œè£…Bç”¨ ğŸ˜¸
            setTimeout(() => {
                let npmList = shelljs.exec('npm list --dept 0') // é¦–å…ˆåˆ¤æ–­æ˜¯å¦å®‰è£…äº†VuePress
                let isNpmVuePress = /vuepress@/.test(npmList)
    
                if (isNpmVuePress) {
                    shelljs.exec('npx vuepress build build') // æ‰§è¡Œshè„šæœ¬
                    spinner.stop()
                } else {
                    console.log('â£ï¸  æ‚¨è¿˜æœªå®‰è£… vuepressï¼ˆnpm install vuepress --saveï¼‰ ')
                    spinner.stop()
                }
            }, 1000)
            
        }
    
    }

    return binHeader[cmd]

}

// titleæ–‡å­—
function titleFu () {
return `
__   __  _ __     ___ 
\\ \\ / / | '_ \\   / _ \\
 \\ V /  | |_) | |  __/
  \\_/   | .__/   \\___|
        |_|                                                                   

è¯´æ˜ï¼š.md ---> .htmlï¼ˆç®€åŒ–VuePressé…ç½®ï¼‰

- vpe init ç”Ÿæˆåˆå§‹åŒ–é¡¹ç›®ï¼ˆå¹¶å¯åŠ¨é¡¹ç›®é¢„è§ˆï¼‰
- vpe serve å¯åŠ¨é¡¹ç›®é¢„è§ˆ
- vpe build æ‰“åŒ…ç”Ÿæˆ html æ–‡ä»¶

`
}

// ç”Ÿæˆé¦–é¡µæ–‡å­—å‡½æ•°
function homeTileFn (dirname) {
return `---
home: true
heroImage: https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/github%E5%9B%BE%E7%89%87/notes/3.png
actionText: ğŸ”¥ è¿™é‡Œæ˜¯ä¸ªæŒ‰é’® â†’
actionLink: /${dirname}/
features:
- title: è§£é‡Šä¸€
  details: è§£é‡Šä¸€å†…å®¹
- title: è§£é‡ŠäºŒ
  details: è§£é‡ŠäºŒå†…å®¹
- title: è§£é‡Šä¸‰
  details: è§£é‡Šä¸‰å†…å®¹
footer: MIT Licensed | Â© Copyright 2019 æœ±æ˜†é¹ - All Rights Reservedï¼ˆç¤ºä¾‹ï¼‰
---`
}

function recordFn () {
    return `# æˆåŠŸ`
}

// init æ—¶å€™ç”Ÿæˆçš„ app.js
function initCreateAppJsFn (dirname) {

let homeTile = homeTileFn(dirname)

return `let fs = require("fs");
let path = require('path')
let stat = fs.stat;

// åŒæ­¥è¯»å–
let homeTile = \`${homeTile}\`

function init() {
        
    // 1.åˆ¤æ–­å¦‚æœæœ‰docsç›®å½•ï¼Œå°±åˆ é™¤æ‰ docsç›®å½•
    if (fs.existsSync(path.join(__dirname,'docs'))) {
        delDirT(path.join(__dirname,'docs'))
    }

    // 2.åˆ›å»ºç›®å½•
    fs.mkdirSync(path.join(__dirname, 'docs'))
    fs.mkdirSync(path.join(__dirname, './docs/.vuepress'))

    // 2.5 å°† record.md å†…å®¹å¤åˆ¶åˆ° æ–‡ä»¶ä¸‹ï¼Œé˜²æ­¢æŠ¥404ï¼ˆå¼‚æ­¥ï¼‰
    fs.readFile('record.md', function (err, data) {
        fs.writeFile('./docs/${dirname}/README.md', data,  function(err) {
          if (err) {
              return console.error(err);
          }
        });
    })

    // 3.æ–‡ä»¶å¤¹å¤åˆ¶
    existsT('./${dirname}','./docs/${dirname}',copyT)

    // 4.ç”Ÿæˆ README.md è¦ä¸ä¼šé¦–é¡µä¼šæŠ¥404
    fs.writeFileSync('./docs/README.md', homeTile)
    
    // 5.éå† ç”Ÿæˆè·¯å¾„å¯¼èˆªï¼ˆç”Ÿæˆè§„åˆ™å†™å…¥ config.jsä¸­ï¼‰
    let strOne = ''
    let one = fs.readdirSync('./${dirname}')
    one.forEach(item => {
        if (!/.md/.${dirname}(item) && item !== '.DS_Store') {
    
          let files2 = []
          let files2Str = ''
          fs.readdirSync(path.join('./${dirname}', item)).forEach( item1 => {
            // Macç³»ç»Ÿä¸‹çš„é—®é¢˜
            if (item1 !== '.DS_Store') {
              files2.push(\`\${path.join(path.join('./${dirname}', item), item1)}\`)
            }
          })
    
          files2.forEach( item2 => {
            files2Str += \`
            '\${item2}',\`
          })
    
          strOne += \`
            {
              title: '\${item}',
              children: [\${files2Str}]
            },
          \`
        }
    })

    // å†™å…¥
    let configStr = \`
    module.exports = {
      title: 'Notes',
      description: 'çŸ¥è¯†é€ŸæŸ¥ï¼ˆäº†ä¸èµ·çš„ä¸ªäººå·¥å…·åº“ï¼‰',
      head: [
        ['link', { rel: 'icon', href: '/favicon.ico' }]
      ],
      themeConfig: {
        repo: 'https://github.com/zhukunpenglinyutong/notes',
        //å¯¼èˆª
        nav: [
          { text: '${dirname}', link: '/${dirname}/' }
        ],
        // ä¾§è¾¹æ 
        sidebar: {
          '/${dirname}': [
            \${strOne}
          ]
        }
      },
      serviceWorker: true,
    }
    \`

    fs.writeFileSync('./docs/.vuepress/config.js', configStr)
}

// å¤åˆ¶æ–‡ä»¶å¤¹
function existsT (src, dst, callback) {
  //æµ‹è¯•æŸä¸ªè·¯å¾„ä¸‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  fs.exists(dst,function(existsT){
      if(existsT){//ä¸å­˜åœ¨
          callback(src,dst);
      }else{//å­˜åœ¨
          fs.mkdir(dst,function(){//åˆ›å»ºç›®å½•
              callback(src,dst)
          })
      }
  })
}

// å¤åˆ¶æ–‡ä»¶å¤¹çš„è¾…åŠ©å‡½æ•°
function copyT (src, dst) {
  //è¯»å–ç›®å½•
  fs.readdir(src,function(err,paths){
      // console.log(paths)
      if(err){
          throw err;
      }
      paths.forEach(function(path){
          var _src=src+'/'+path;
          var _dst=dst+'/'+path;
          var readable;
          var writable;
          stat(_src,function(err,st){
              if(err){
                  throw err;
              }
              
              if(st.isFile()){
                  readable=fs.createReadStream(_src);//åˆ›å»ºè¯»å–æµ
                  writable=fs.createWriteStream(_dst);//åˆ›å»ºå†™å…¥æµ
                  readable.pipe(writable);
              }else if(st.isDirectory()){
                  exists(_src,_dst,copyT);
              }
          });
      });
  });
}

// åˆ é™¤æ–‡ä»¶å¤¹
function delDirT (path){
    let files = [];
    if(fs.existsSync(path)){
        files = fs.readdirSync(path);
        files.forEach((file, index) => {
            let curPath = path + "/" + file;
            if(fs.statSync(curPath).isDirectory()){
                delDirT(curPath); //é€’å½’åˆ é™¤æ–‡ä»¶å¤¹
            } else {
                fs.unlinkSync(curPath); //åˆ é™¤æ–‡ä»¶
            }
        });
        fs.rmdirSync(path);
    }
}

init() // å¯åŠ¨`

}

// éå†æ–‡ä»¶å¤¹ï¼Œç”Ÿæˆæ–‡ä»¶å¯¹è±¡æ ‘
function readDirToObjTree(){
    
    let foldPath = shelljs.pwd().stdout // å½“å‰ç›®å½•çš„ç»å¯¹è·¯å¾„
    let objTree = []

    function recursion (foldPath, data, isRootPath = true) {

        let files = fs.readdirSync(foldPath)
        // console.log('1ï¸âƒ£ è¯»å–æŸä¸ªç›®å½•ä¸‹çš„ç›®å½•ç»“æ„', files)
        
        // 1.ç›®å½•å¾ªç¯
        files.forEach(item => {
            // å¦‚æœæœ‰é…ç½®è¡¨ï¼Œè¿™é‡Œè¿˜éœ€è¦è¿›è¡Œé…ç½®è¿‡æ»¤ä¸€ä¸‹

            let isDir = fs.statSync(`${foldPath}/${item}`).isDirectory()
            // console.log(`â£ï¸ ${item} æ˜¯å¦æ˜¯ æ–‡ä»¶å¤¹`, isDir)

            // æ ¸å¿ƒæ•°æ®å¤„ç†
            if (isDir && item !==  'node_modules' && item !==  'build') {
                // console.log('ğŸ”¥ å¯ä»¥è¿›å…¥åˆ°ç”Ÿæˆç›®å½•çš„æ–‡ä»¶å¤¹', item)
                data.push({
                    name: item,
                    data: [],
                    path: `${foldPath}/${item}`
                })
            } else if (!isRootPath) {
                // console.log('âœ… ä¸æ˜¯æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸”ä¸æ˜¯ç¬¬ä¸€çº§', item)
                data.push(item)
            }

        })

        // 2.éå†ç›®å½•å¾ªç¯ï¼ˆé€’å½’ï¼‰
        data.length > 0 && data[0].name !== undefined 
            ? data.forEach(item => recursion(item.path, item.data, false)) 
            : ''
    }

    recursion(foldPath, objTree)

    return objTree
}

// **************** æ ¹æ®æ–‡æ¡£å¯¹è±¡æ ‘ ç”Ÿæˆ build *************
// ç”ŸæˆVuePressè§„åˆ™
function createVuePressInit (objTree) {
    createDist() // åˆ›å»ºæ‰“åŒ…ä¹‹åçš„ç›®å½•
    copyDirFn(objTree) // å¤åˆ¶æ–‡ä»¶
    createVuePressConfig(objTree) // æ ¹æ®æ–‡ä»¶å¯¹è±¡æ ‘ï¼Œç”ŸæˆVuePressè§„åˆ™
    createBasicFile(objTree) // ç”ŸæˆREADME.md æ–‡ä»¶ï¼Œä¸å†™çš„è¯ä¼šæœ‰é—®é¢˜
}

// 1.åˆ›å»ºæ‰“åŒ…ä¹‹åçš„ç›®å½•build
function createDist () {
    
    let dirPath = shelljs.pwd().stdout

    // å¦‚æœæœ‰å’Œæ‰“åŒ…åç§°ä¸€è‡´çš„åç§°ï¼Œå°±å…ˆåˆ é™¤æ‰
    if (fs.existsSync(path.join(dirPath, "build"))) {
        delDir(path.join(dirPath, "build"))
    }

    // åˆ›å»ºç›®å½•
    fs.mkdirSync(path.join(dirPath, "build"))
    fs.mkdirSync(path.join(dirPath, `./build/.vuepress`))
    console.log('1ï¸âƒ£  åˆ›å»ºæ‰“åŒ…æ–‡ä»¶å¤¹æˆåŠŸ')

}

// 2.å¤åˆ¶æ–‡ä»¶å¤¹åˆ°build
function copyDirFn (objTree) {
    objTree.forEach(item => {
        let dirPath = shelljs.pwd().stdout
        // console.log(item.path)
        // console.log(`${dirPath}/build/${item.name}`)        
        exists(item.path, `${dirPath}/build/${item.name}`, copy)
    })
    console.log('2ï¸âƒ£  å¤åˆ¶æ–‡ä»¶åˆ°æ‰“åŒ…ç›®å½•å®Œæˆ')
}

// 3.ç”ŸæˆVuePressè§„åˆ™
function createVuePressConfig (objTree) {

    let nav = ''
    let sidebar = ''

    objTree.forEach(item => {

        // 1.ç”Ÿæˆå¯¼èˆª
        nav += `
            {
                text: '${item.name}',
                link: '/${item.name}/'
            },
        `;

        // 2.ç”Ÿæˆä¾§è¾¹æ 
        
        // é¦–å…ˆå…ˆå¾ªç¯æœ¬å±‚çš„äºŒçº§ç›®å½•
        let twLevel = ''
        item.data.forEach(jtem => {

            let children = ''
            jtem.data.forEach(ztem => {
                children += `'${item.name}/${jtem.name}/${ztem}',
                        `
            })

            twLevel += `
                {
                    title: '${jtem.name}',
                    children: [
                        ${children}
                    ]
                },
            `
        })

        // æ‹¼æ¥
        sidebar += `
            '/${item.name}': [
                ${twLevel}
            ],
        `

    })

let configStr = `module.exports = {
    title: 'Notes',
    description: 'çŸ¥è¯†é€ŸæŸ¥ï¼ˆäº†ä¸èµ·çš„ä¸ªäººå·¥å…·åº“ï¼‰',
    head: [
        ['link', { rel: 'icon', href: '/favicon.ico' }]
    ],
    themeConfig: {
        repo: 'https://github.com/zhukunpenglinyutong/notes',
        //å¯¼èˆª
        nav: [
            ${nav}
        ],
        // ä¾§è¾¹æ 
        sidebar: {
            ${sidebar}
        }
    },
    serviceWorker: true,
    markdown: {
        lineNumbers: true // å¼€å¯è¡Œå·
    }
}`
    let dirPath = shelljs.pwd().stdout
    fs.writeFileSync(`${dirPath}/build/.vuepress/config.js`, configStr)
    console.log('3ï¸âƒ£  æ ¹æ®æ–‡ä»¶å¯¹è±¡æ ‘ï¼Œç”ŸæˆVuePressè§„åˆ™å®Œæˆ')
}

// 4.ç”ŸæˆREADME.mdæ–‡ä»¶ï¼ˆå¼‚æ­¥ï¼‰
function createBasicFile (objTree) {
    
    // åœ¨æ‰“åŒ…æ–‡ä»¶å¤¹æ ¹ç›®å½• ç”Ÿæˆ README.md è¦ä¸ä¼švuepressä¼šäº§ç”Ÿ404
    let homeTile = homeTileFn()
    let dirPath = shelljs.pwd().stdout
    fs.writeFileSync(`${dirPath}/build/README.md`, homeTile)

    setTimeout(() => {
        // åœ¨æ‰“åŒ…æ–‡ä»¶å¤¹ æ¯ä¸ªåˆ†ç±»æ–‡ä»¶å¤¹ä¸‹ ç”Ÿæˆ README.mdï¼Œå¦åˆ™å†…å®¹æ˜¾ç¤ºä¸å‡ºæ¥
        let record = recordFn()
        objTree.forEach(item => {
            // console.log('ğŸ”¥', `${dirPath}/build/${item.name}/README.md`)
            fs.writeFileSync(`${dirPath}/build/${item.name}/README.md`, record)
        })
        console.log('4ï¸âƒ£  ç”ŸæˆREADME.md æ–‡ä»¶å®Œæˆ')

    }, 100);
}

// å¤åˆ¶æ–‡ä»¶å¤¹ï¼ˆå·¥å…·å‡½æ•°ï¼‰
function exists (src, dst, callback) {
    //æµ‹è¯•æŸä¸ªè·¯å¾„ä¸‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    fs.exists(dst, function(exists){
        if (exists) {//ä¸å­˜åœ¨
            callback(src,dst);
        } else {//å­˜åœ¨
            fs.mkdir(dst,function(){//åˆ›å»ºç›®å½•
                callback(src,dst)
            })
        }
    })
}

// å¤åˆ¶æ–‡ä»¶å¤¹çš„è¾…åŠ©å‡½æ•°ï¼ˆå·¥å…·å‡½æ•°ï¼‰
function copy (src, dst) {
    //è¯»å–ç›®å½•
    let paths = fs.readdirSync(src);
    paths.forEach(function(path){
        var _src=src+'/'+path;
        var _dst=dst+'/'+path;
        var readable;
        var writable;
        stat(_src,function(err,st){
            if(err){
                throw err;
            }
            
            if(st.isFile()){
                readable=fs.createReadStream(_src);//åˆ›å»ºè¯»å–æµ
                writable=fs.createWriteStream(_dst);//åˆ›å»ºå†™å…¥æµ
                readable.pipe(writable);
            }else if(st.isDirectory()){
                exists(_src,_dst,copy);
            }
        });
    });
}
  
// åˆ é™¤æ–‡ä»¶å¤¹ï¼ˆå·¥å…·å‡½æ•°ï¼‰
function delDir(path){
    let files = [];
    if(fs.existsSync(path)){
        files = fs.readdirSync(path);
        files.forEach((file, index) => {
            let curPath = path + "/" + file;
            if(fs.statSync(curPath).isDirectory()){
                delDir(curPath); //é€’å½’åˆ é™¤æ–‡ä»¶å¤¹
            } else {
                fs.unlinkSync(curPath); //åˆ é™¤æ–‡ä»¶
            }
        });
        fs.rmdirSync(path);
    }
}


// ä¸€èˆ¬æ¥è¯´ä¼šéå† æ–‡ä»¶ä¸‹æ‰€æœ‰çš„æ–‡ä»¶ï¼Œç”Ÿæˆç»“æ„ï¼Œå¦‚æœä½ æƒ³æœ‰æ–‡ä»¶å¤¹ä¸å‚ä¸ç”Ÿæˆç»“æ„ï¼Œå¯ä»¥è¿›è¡Œé…ç½®
// vpe.config.js

init()