#!/usr/bin/env node
const program = require('commander') // æ ¸å¿ƒå‘½ä»¤è¡Œå·¥å…·
const inquirer = require('inquirer') // è·Ÿç”¨æˆ·è¿›è¡Œäº¤äº’
const ora = require('ora') // loadingæ¨¡å—
const shelljs = require('shelljs'); // å‰ç«¯å†™shell
const fs = require('fs');
const path = require('path');


// å…¨å±€
let dirPath = shelljs.pwd().stdout
let stat = fs.stat;
let vpeConfigObj = getVpeConfig(); // é…ç½®å¯¹è±¡


// ===================================================
// ============== ** npmæ ¸å¿ƒå‘½ä»¤éƒ¨åˆ† ** ================
// ===================================================

programConfigFn() // æ ¸å¿ƒå‘½ä»¤è¡Œé…ç½®å‡½æ•°å¯åŠ¨

// æ ¸å¿ƒå‘½ä»¤è¡Œé…ç½®å‡½æ•°
function programConfigFn () {
    
    // -v ç‰ˆæœ¬
    program.version('v1.1.0', "-v, --version")
    // -h å¸®åŠ©
    program.on('--help', () => { console.log(helpTitleFu()) });

    program
        .usage("[cmd] <options>")
        .arguments('<cmd> [env]')
        .action( (cmd, otherParms) => {
            let header = binHeaderFn(cmd)
            typeof header === 'undefined' ? process.exit(1) : header()
        })

    program.parse(process.argv)
}

// å‘½ä»¤é›†åˆå‡½æ•°
function binHeaderFn (cmd) {
    
    let binHeader = {

        // åˆå§‹åŒ–é¡¹ç›®é›†åˆ
        init () {
            console.log('ç”Ÿæˆä¸€ä¸ªåˆå§‹åŒ–é¡¹ç›®ï¼ˆåŠŸèƒ½æš‚æœªå¼€æ”¾ï¼‰')
            // inquirer.prompt([
            //     {
            //         type: 'text',
            //         message: 'æ­¤æ“ä½œä¼šåœ¨å½“å‰è·¯å¾„ä¸‹åˆ›å»ºåˆå§‹åŒ–æ–‡ä»¶å¤¹ï¼Œè¯·æ‚¨è‡ªå®šä¹‰æ­¤æ–‡ä»¶å¤¹åç§°ï¼ˆè‹±æ–‡ï¼‰',
            //         name: 'dirname'
            //     }
            // ]).then( answers => {
                
            //     let { dirname } = answers
                
            //     const spinner = ora('vpeæ­£åœ¨ä¸ºæ‚¨åˆå§‹åŒ–é¡¹ç›®')
            //     spinner.start()

            //     let initCreateAppJs = initCreateAppJsFn(dirname) // ç”Ÿæˆåˆå§‹åŒ– init app.js
            //     shelljs.echo(initCreateAppJs).to('app.js')

            //     setTimeout( () => {
                    
            //         shelljs.cd(shelljs.pwd().stdout) // è¿›å…¥å½“å‰ç›®å½•
            //         shelljs.mkdir(dirname)

            //         shelljs.exec('node app.js')
            //         shelljs.exec('npx vuepress dev docs')
                    
            //         spinner.stop()
            //         console.log('åˆå§‹åŒ–å®Œæˆ')
            //     }, 1000)
            // })
        },

        serve () {
            
            let dirObjTree = readDirToObjTree() // éå†æ‰€æœ‰çš„æ–‡ä»¶å¤¹ ---> ç”Ÿæˆæ–‡ä»¶å¯¹è±¡æ ‘            
            createVuePressInit(dirObjTree) // æ ¹æ®æ–‡ä»¶å¯¹è±¡æ ‘ï¼Œç”ŸæˆVuePressè§„åˆ™


            const spinner = ora('vpeæ­£åœ¨å¯åŠ¨é¢„è§ˆåŠŸèƒ½...')
            spinner.start()

            // æš‚åœ 1sï¼Œä¸»è¦æ˜¯æœ‰ä¸ªåŠ è½½çŠ¶æ€ï¼Œè£…Bç”¨ ğŸ˜¸
            setTimeout(() => {
                let npmList = shelljs.exec('npm list --dept 0') // é¦–å…ˆåˆ¤æ–­æ˜¯å¦å®‰è£…äº†VuePress
                let isNpmVuePress = /vuepress@/.test(npmList)
    
                if (isNpmVuePress) {
                    shelljs.exec('npx vuepress dev build') // æ‰§è¡Œshè„šæœ¬
                    spinner.stop()
                } else {
                    console.log('â£ï¸  æ‚¨è¿˜æœªå®‰è£… vuepressï¼ˆnpm install vuepress --saveï¼‰ ')
                    spinner.stop()
                }
            }, 1000)
        },

        build () {

            let dirObjTree = readDirToObjTree() // éå†æ‰€æœ‰çš„æ–‡ä»¶å¤¹ ---> ç”Ÿæˆæ–‡ä»¶å¯¹è±¡æ ‘            
            createVuePressInit(dirObjTree) // æ ¹æ®æ–‡ä»¶å¯¹è±¡æ ‘ï¼Œç”ŸæˆVuePressè§„åˆ™


            const spinner = ora('vpeæ­£åœ¨ç¼–è¯‘ä¸­ï¼ˆç¼–è¯‘åçš„æ–‡ä»¶åœ¨ build/.vuepress/dist ä¸­ï¼‰')
            spinner.start()

            // æš‚åœ 1sï¼Œä¸»è¦æ˜¯æœ‰ä¸ªåŠ è½½çŠ¶æ€ï¼Œè£…Bç”¨ ğŸ˜¸
            setTimeout(() => {
                let npmList = shelljs.exec('npm list --dept 0') // é¦–å…ˆåˆ¤æ–­æ˜¯å¦å®‰è£…äº†VuePress
                let isNpmVuePress = /vuepress@/.test(npmList)
    
                if (isNpmVuePress) {
                    shelljs.exec('npx vuepress build build') // æ‰§è¡Œshè„šæœ¬
                    spinner.stop()
                } else {
                    console.log('â£ï¸  æ‚¨è¿˜æœªå®‰è£… vuepressï¼ˆnpm install vuepress --saveï¼‰ ')
                    spinner.stop()
                }
            }, 1000)
            
        },

        config () {

            const spinner = ora('vpeæ­£åœ¨å¯åŠ¨é…ç½®å¯è§†åŒ–')
            spinner.start()

            // ä¸»è¦ç”¨äºè‡ªå®šä¹‰é…ç½®çš„
            
            // å…ˆçœ‹æœ‰æ²¡æœ‰ vpe.config.json æ²¡æœ‰çš„è¯ï¼Œèµ°åˆå§‹åŒ–é¡¹ç›®
            // ç”Ÿæˆ HOME.md && RECORD.md

            setTimeout(() => {

                inquirer.prompt([
                    {
                        type: 'checkbox',
                        name: 'config',
                        message: 'è¯·é€‰æ‹©è¦ç”Ÿæˆçš„é…ç½®é¡¹ï¼ˆå»ºè®®ä¸‰é¡¹å…¨é€‰ï¼Œç©ºæ ¼é€‰ä¸­ï¼‰',
                        choices: [
                            {name: 'ç½‘å€æ ¹ç›®å½•é…ç½®ï¼ˆHOME.mdï¼‰', value: 'homeMd'},
                            {name: 'è·³è½¬ç›®å½•é¦–å±æ˜¾ç¤ºå†…å®¹é…ç½®ï¼ˆRECORD.mdï¼‰', value: 'recordMd'},
                            {name: 'ç”Ÿæˆè¿›è¡Œæ›´è¯¦ç»†çš„é…ç½®ï¼ˆvpn.config.jsonï¼‰', value: 'configJson'}
                        ]
                    }
                ]).then( answers => {
                    answers.config.forEach(configName => {
                        switch (configName) {
                            case 'homeMd': createHomeFn(); break;
                            case 'recordMd': createRecordFn(); break;
                            case 'configJson': createConfigFn(); break;
                        }
                    })
                })

                spinner.stop()
            }, 500);

        }
    
    }

    return binHeader[cmd]
}


// ===================================================
// =============== ** config å‘½ä»¤ ** =================
// ===================================================

// åˆ›å»º HOME.md çš„å‡½æ•°
function createHomeFn() {
    fs.writeFileSync(`${dirPath}/HOME.md`, homeTileFn())
}

// åˆ›å»º RECORD.md çš„å‡½æ•°
function createRecordFn() {
    fs.writeFileSync(`${dirPath}/RECORD.md`, recordFn())
}

// åˆ›å»º vpe.config.json çš„å‡½æ•°
function createConfigFn() {
    fs.writeFileSync(`${dirPath}/vpe.config.json`, vpeConfigFn())
}

// ç”Ÿæˆ vpe.config.json å†…å®¹
function vpeConfigFn () {
return `{
    // å·¦ä¸Šè§’çš„æ ‡é¢˜ï¼ˆä¹Ÿæ˜¯é¦–é¡µå›¾åƒä¸‹é¢çš„ä¸€çº§æ ‡é¢˜ï¼‰
    "title": "åœ¨vpe.config.json ä¸­ é…ç½® title",
    // é¦–é¡µå¤´åƒä¸‹é¢æ ‡é¢˜çš„è§£é‡Š
    "description": "åœ¨vpe.config.json ä¸­ é…ç½® description",
    // å³ä¸Šè§’ è·³è½¬GitHubçš„åœ°å€ï¼ˆå†™ä¸€ä¸ªGitHubé¡¹ç›®åœ°å€ï¼‰
    "repo": "https://github.com/itz2019/vuepress-es"
}`
}


// ===================================================
// =========== ** serve && build å‘½ä»¤ ** =============
// ===================================================

// éå†æ–‡ä»¶å¤¹ï¼Œç”Ÿæˆæ–‡ä»¶å¯¹è±¡æ ‘
function readDirToObjTree(){
    
    let foldPath = shelljs.pwd().stdout // å½“å‰ç›®å½•çš„ç»å¯¹è·¯å¾„
    let objTree = []

    function recursion (foldPath, data, isRootPath = true) {

        let files = fs.readdirSync(foldPath)
        // console.log('1ï¸âƒ£ è¯»å–æŸä¸ªç›®å½•ä¸‹çš„ç›®å½•ç»“æ„', files)
        
        // 1.ç›®å½•å¾ªç¯
        files.forEach(item => {
            // å¦‚æœæœ‰é…ç½®è¡¨ï¼Œè¿™é‡Œè¿˜éœ€è¦è¿›è¡Œé…ç½®è¿‡æ»¤ä¸€ä¸‹

            let isDir = fs.statSync(`${foldPath}/${item}`).isDirectory()
            // console.log(`â£ï¸ ${item} æ˜¯å¦æ˜¯ æ–‡ä»¶å¤¹`, isDir)

            // æ ¸å¿ƒæ•°æ®å¤„ç†
            if (isDir && item !==  'node_modules' && item !==  'build') {
                // console.log('ğŸ”¥ å¯ä»¥è¿›å…¥åˆ°ç”Ÿæˆç›®å½•çš„æ–‡ä»¶å¤¹', item)
                data.push({
                    name: item,
                    data: [],
                    path: `${foldPath}/${item}`
                })
            } else if (!isRootPath) {
                // console.log('âœ… ä¸æ˜¯æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸”ä¸æ˜¯ç¬¬ä¸€çº§', item)
                data.push(item)
            }

        })

        // 2.éå†ç›®å½•å¾ªç¯ï¼ˆé€’å½’ï¼‰
        data.length > 0 && data[0].name !== undefined 
            ? data.forEach(item => recursion(item.path, item.data, false)) 
            : ''
    }

    recursion(foldPath, objTree)

    return objTree
}

// **************** æ ¹æ®æ–‡æ¡£å¯¹è±¡æ ‘ ç”Ÿæˆ build *************

// ç”ŸæˆVuePressè§„åˆ™
function createVuePressInit (objTree) {
    createDist() // åˆ›å»ºæ‰“åŒ…ä¹‹åçš„ç›®å½•
    copyDirFn(objTree) // å¤åˆ¶æ–‡ä»¶
    createVuePressConfig(objTree) // æ ¹æ®æ–‡ä»¶å¯¹è±¡æ ‘ï¼Œç”ŸæˆVuePressè§„åˆ™
    createBasicFile(objTree) // ç”ŸæˆREADME.md æ–‡ä»¶ï¼Œä¸å†™çš„è¯ä¼šæœ‰é—®é¢˜
}

// 1.åˆ›å»ºæ‰“åŒ…ä¹‹åçš„ç›®å½•build
function createDist () {

    // å¦‚æœæœ‰å’Œæ‰“åŒ…åç§°ä¸€è‡´çš„åç§°ï¼Œå°±å…ˆåˆ é™¤æ‰
    if (fs.existsSync(path.join(dirPath, "build"))) {
        delDir(path.join(dirPath, "build"))
    }

    // åˆ›å»ºç›®å½•
    fs.mkdirSync(path.join(dirPath, "build"))
    fs.mkdirSync(path.join(dirPath, `./build/.vuepress`))
    console.log('1ï¸âƒ£  åˆ›å»ºæ‰“åŒ…æ–‡ä»¶å¤¹æˆåŠŸ')

}

// 2.å¤åˆ¶æ–‡ä»¶å¤¹åˆ°build
function copyDirFn (objTree) {
    objTree.forEach(item => {  
        exists(item.path, `${dirPath}/build/${item.name}`, copy)
    })
    console.log('2ï¸âƒ£  å¤åˆ¶æ–‡ä»¶åˆ°æ‰“åŒ…ç›®å½•å®Œæˆ')
}

// 3.ç”ŸæˆVuePressè§„åˆ™
function createVuePressConfig (objTree) {

    let nav = ''
    let sidebar = ''

    objTree.forEach(item => {

        // 1.ç”Ÿæˆå¯¼èˆª
        nav += `
            {
                text: '${item.name}',
                link: '/${item.name}/'
            },
        `;

        // 2.ç”Ÿæˆä¾§è¾¹æ 
        
        // é¦–å…ˆå…ˆå¾ªç¯æœ¬å±‚çš„äºŒçº§ç›®å½•
        let twLevel = ''
        item.data.forEach(jtem => {

            let children = ''
            jtem.data.forEach(ztem => {
                children += `'${item.name}/${jtem.name}/${ztem}',
                        `
            })

            twLevel += `
                {
                    title: '${jtem.name}',
                    children: [
                        ${children}
                    ]
                },
            `
        })

        // æ‹¼æ¥
        sidebar += `
            '/${item.name}': [
                ${twLevel}
            ],
        `

    })

// è¯»å–é…ç½®é›†åˆ

let title = getConfig('title', 'åœ¨ vpe.config.json ä¸­é…ç½® title')
let description = getConfig('description', 'åœ¨ vpe.config.json ä¸­é…ç½® description')
let repo = getConfig('repo', 'https://github.com/itz2019/vuepress-es')

let configStr = `module.exports = {
    title: '${title}',
    description: '${description}',
    head: [
        ['link', { rel: 'icon', href: '/favicon.ico' }]
    ],
    themeConfig: {
        repo: '${repo}',
        //å¯¼èˆª
        nav: [
            ${nav}
        ],
        // ä¾§è¾¹æ 
        sidebar: {
            ${sidebar}
        }
    },
    serviceWorker: true,
    markdown: {
        lineNumbers: true // å¼€å¯è¡Œå·
    }
}`;
    fs.writeFileSync(`${dirPath}/build/.vuepress/config.js`, configStr)
    console.log('3ï¸âƒ£  æ ¹æ®æ–‡ä»¶å¯¹è±¡æ ‘ï¼Œç”ŸæˆVuePressè§„åˆ™å®Œæˆ')
}

// 4.ç”ŸæˆREADME.mdæ–‡ä»¶ï¼ˆå¼‚æ­¥ï¼‰
function createBasicFile (objTree) {
    
    // åœ¨æ‰“åŒ…æ–‡ä»¶å¤¹æ ¹ç›®å½• ç”Ÿæˆ README.md è¦ä¸ä¼švuepressä¼šäº§ç”Ÿ404
    let homeTile = homeTileFn()
    fs.writeFileSync(`${dirPath}/build/README.md`, homeTile)

    setTimeout(() => {
        // åœ¨æ‰“åŒ…æ–‡ä»¶å¤¹ æ¯ä¸ªåˆ†ç±»æ–‡ä»¶å¤¹ä¸‹ ç”Ÿæˆ README.mdï¼Œå¦åˆ™å†…å®¹æ˜¾ç¤ºä¸å‡ºæ¥
        let record = recordFn()
        objTree.forEach(item => {
            // console.log('ğŸ”¥', `${dirPath}/build/${item.name}/README.md`)
            fs.writeFileSync(`${dirPath}/build/${item.name}/README.md`, record)
        })
        console.log('4ï¸âƒ£  ç”ŸæˆREADME.md æ–‡ä»¶å®Œæˆ')

    }, 100);
}

// è¯»å–é…ç½®ï¼Œå¹¶ä¸”é…ç½®æ²¡æœ‰çš„æ—¶å€™ï¼Œç”Ÿæˆæç¤ºè¯­å¥ï¼ˆå·¥å…·å‡½æ•°ï¼‰
function getConfig (configName, explain) {
    return vpeConfigObj ? vpeConfigObj[configName] : explain
}


// ===================================================
// ================= ** é€šç”¨å‡½æ•° ** ===================
// ===================================================

// å¤åˆ¶æ–‡ä»¶å¤¹ï¼ˆå·¥å…·å‡½æ•°ï¼‰
function exists (src, dst, callback) {
    //æµ‹è¯•æŸä¸ªè·¯å¾„ä¸‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    fs.exists(dst, function(exists){
        if (exists) {//ä¸å­˜åœ¨
            callback(src,dst);
        } else {//å­˜åœ¨
            fs.mkdir(dst,function(){//åˆ›å»ºç›®å½•
                callback(src,dst)
            })
        }
    })
}

// å¤åˆ¶æ–‡ä»¶å¤¹çš„è¾…åŠ©å‡½æ•°ï¼ˆå·¥å…·å‡½æ•°ï¼‰
function copy (src, dst) {
    //è¯»å–ç›®å½•
    let paths = fs.readdirSync(src);
    paths.forEach(function(path){
        var _src=src+'/'+path;
        var _dst=dst+'/'+path;
        var readable;
        var writable;
        stat(_src,function(err,st){
            if(err){
                throw err;
            }
            
            if(st.isFile()){
                readable=fs.createReadStream(_src);//åˆ›å»ºè¯»å–æµ
                writable=fs.createWriteStream(_dst);//åˆ›å»ºå†™å…¥æµ
                readable.pipe(writable);
            }else if(st.isDirectory()){
                exists(_src,_dst,copy);
            }
        });
    });
}
  
// åˆ é™¤æ–‡ä»¶å¤¹ï¼ˆå·¥å…·å‡½æ•°ï¼‰
function delDir(path){
    let files = [];
    if(fs.existsSync(path)){
        files = fs.readdirSync(path);
        files.forEach((file, index) => {
            let curPath = path + "/" + file;
            if(fs.statSync(curPath).isDirectory()){
                delDir(curPath); //é€’å½’åˆ é™¤æ–‡ä»¶å¤¹
            } else {
                fs.unlinkSync(curPath); //åˆ é™¤æ–‡ä»¶
            }
        });
        fs.rmdirSync(path);
    }
}

// vpe help æ˜¾ç¤ºçš„æ–‡å­—ï¼ˆå·¥å…·ç±»ï¼‰
function helpTitleFu () {
return `
__   __  _ __     ___ 
\\ \\ / / | '_ \\   / _ \\
 \\ V /  | |_) | |  __/
  \\_/   | .__/   \\___|
        |_|                                                                   

è¯´æ˜ï¼š.md ---> .htmlï¼ˆç®€åŒ–VuePressé…ç½®ï¼‰

- vpe init ç”Ÿæˆåˆå§‹åŒ–é¡¹ç›®ï¼ˆæœªå¼€æ”¾ï¼‰
- vpe serve å¯åŠ¨é¡¹ç›®é¢„è§ˆ
- vpe build æ‰“åŒ…ç”Ÿæˆ html æ–‡ä»¶
`
}

// è·å– vpe.config.json å†…å®¹
function getVpeConfig () {
    try {
        // è¯»å– vpe.config.json å†…å®¹
        var dataStr = fs.readFileSync('vpe.config.json').toString();
        return eval("("+ dataStr +")")
    } catch (e) {
    }
}

// ç”Ÿæˆ HOME.md æ–‡ä»¶çš„å†…å®¹ && è¯»å– HOME.md
function homeTileFn () {
    try {
        // è¯»å– HOME.md å†…å®¹
        var dataStr = fs.readFileSync('HOME.md').toString();
        return dataStr
    } catch (e) {
return `---
# å¦‚æœä¸‹é¢æŸä¸ªæ•ˆæœä½ ä¸æƒ³ä½¿ç”¨ï¼Œç›´æ¥æ³¨é‡Šæˆ–è€…åˆ é™¤å³å¯
# æ˜¯å¦å¯åŠ¨homeé¡µé¢
home: true
# å›¾åƒ
heroImage: https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/github%E5%9B%BE%E7%89%87/vuepress-es/1.HOME%E5%A4%B4%E5%83%8F%E5%9B%BE%E7%89%87.png
# æŒ‰é’®æ˜¾ç¤ºæ–‡å­—
actionText: ğŸ”¥ åœ¨HOME.mdä¸­è®¾ç½®è¿™é‡Œçš„æ–‡å­— â†’
# æŒ‰é’®è·³è½¬çš„è¿æ¥
actionLink: /æµ‹è¯•/
# è§£é‡Š
features:
- title: è§£é‡Šä¸€ï¼ˆåœ¨HOME.mdä¸­è®¾ç½®ï¼‰ # æ ‡é¢˜
  details: è§£é‡Šä¸€å†…å®¹ # å†…å®¹
- title: è§£é‡ŠäºŒ
  details: è§£é‡ŠäºŒå†…å®¹
- title: è§£é‡Šä¸‰
  details: è§£é‡Šä¸‰å†…å®¹
# è„šå¤´
footer: MIT Licensed | Â© Copyright 2019 æœ±æ˜†é¹ - All Rights Reservedï¼ˆåœ¨HOME.mdä¸­è®¾ç½®ï¼‰
---`
    }
}

// ç”Ÿæˆ RECORD.md æ–‡ä»¶çš„å†…å®¹ && è¯»å– HOME.md
function recordFn () {
    try {
        // è¯»å– HOME.md å†…å®¹
        var dataStr = fs.readFileSync('RECORD.md').toString();
        return dataStr
    } catch (e) {
        return `# è¿™é‡Œä¹¦å†™çš„è§„åˆ™ï¼Œå°±æ˜¯æ™®é€šçš„ .md çš„è§„åˆ™ï¼ˆå†…å®¹åœ¨ RECORD.md ä¸­ä¿®æ”¹ï¼‰`
    }
}